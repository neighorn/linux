#! /bin/bash
while ps -ef | grep dirvish | grep -qv grep
do
	now=`date +%T`

	# Report on rsync's in progress
	ps -ef |
	grep rsync |
	grep -v grep |
	while read trash pid trash
	do
		lsof -p $pid
	done |
	grep tree/ |
	while read trash pid trash fh type trash item7 item8 rest
	do
		if [[ "$type" = "unknown" ]]
		then
			filename="$item7 item8 rest"
		else
			filename="${rest# *}"
			filename="${filename# *}"
		fi
		#[[ $fh = [0-9]*r ]] || continue		# Filter out output file.
		filename="${filename% (*}"			# Clean up NFS mounts.
		filename="${filename%/*}"			# Get to directory, not temp file.
		percent=`df -h "$filename" | awk '!/Filesystem/ {gsub(/%/,"",$5);print \$5}'`
		printf "%-s %5d %-6s % 3d%%: %s\n" $now $pid "rsync" $percent "$filename"
	done |
	sort

	# Report on dirvish-expire in progress
	prior=''
	ps -ef | 
	grep dirvish-expire |
	grep -v grep |
	while read trash pid trash
	do
		line=`pstree -p $pid`
		line=${line##*--rm(}
		line=${line%%)*}
		[[ $line =~ /^[0-9]+$/ ]] || continue
		[[ -n $line ]] && lsof -p $line | 
			grep ' [0-9]r  *DIR '
	done |
	while read trash pid trash trash trash trash trash trash dir
	do
		dir=${dir%%/tree/*}
		percent=`df -h "$dir" | awk '!/Filesystem/ {gsub(/%/,"",$5);print \$5}'`
		printf "%-s %5d %-6s % 3d%%: %s\n" $now $pid "expire" $percent "$dir"
	done |
	sort -r |
	while read current
	do
		if [[ -z "$prior" || "$prior" != $current* ]]
		then
			echo "$current"
		fi
		prior=$current
	done
	sleep 30
done
date '+No dirvish processes running at %T'

